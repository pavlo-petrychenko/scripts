#!/usr/bin/env bash
# wtld - list worktrees and remove a selected one (worktree + tmux window)

set -euo pipefail

repo_root=$(git rev-parse --show-toplevel 2>/dev/null) || {
  echo "Error: not inside a git repo"
  exit 1
}

parent_dir=$(dirname "$repo_root")
main_repo="$parent_dir/website"

if [ ! -d "$main_repo" ]; then
  echo "Error: main repo not found at $main_repo"
  exit 1
fi

# List worktrees (excluding main repo)
worktrees=$(ls -d "$parent_dir"/website-* 2>/dev/null | xargs -I{} basename {} | sed 's/^website-//' || true)

if [ -z "$worktrees" ]; then
  echo "No worktrees to remove"
  exit 0
fi

# Mark which ones have tmux windows open
labeled=""
open_windows=""
if [ -n "${TMUX:-}" ]; then
  open_windows=$(tmux list-windows -F '#W' 2>/dev/null || true)
fi

while IFS= read -r name; do
  if echo "$open_windows" | grep -qx "$name"; then
    labeled+="$name  [open]"$'\n'
  else
    labeled+="$name"$'\n'
  fi
done <<< "$worktrees"

# Pick with fzf
selection=$(echo "$labeled" | sed '/^$/d' | fzf --prompt="Remove worktree: " --height=40% --reverse --ansi) || exit 0
name=$(echo "$selection" | awk '{print $1}')

if [ -z "$name" ]; then
  exit 0
fi

# Confirm
echo "Remove worktree: website-$name (branch: $name)"
read -p "Are you sure? (y/N) " confirm
if [[ "$confirm" != [yY] ]]; then
  echo "Cancelled"
  exit 0
fi

# Kill tmux window if it exists
if [ -n "${TMUX:-}" ]; then
  target_window_id=$(tmux list-windows -F '#{window_name} #{window_id}' | awk -v n="$name" '$1 == n {print $2}')
  if [ -n "$target_window_id" ]; then
    tmux kill-window -t "$target_window_id"
  fi
fi

# Remove worktree and branch
cd "$main_repo"
make worktree-remove name="$name"

echo "Removed worktree: website-$name"
