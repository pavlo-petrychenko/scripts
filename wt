#!/usr/bin/env bash
# wt - create worktree via `make worktree` + tmux window with 3-pane layout
# Usage: wt <name> [flags...]
#   Flags are forwarded to `make worktree` (e.g. --no-install, --symlink, --verbose)
#
# Layout:
# ┌──────────┬──────────┐
# │  agent   │   root   │
# ├──────────┴──────────┤
# │        logs         │
# └─────────────────────┘

set -euo pipefail

if [ $# -lt 1 ] || [[ "$1" == --* ]]; then
  echo "Usage: wt <name> [--no-install] [--no-init] [--verbose] [--full-install] [--symlink]"
  exit 1
fi

name="$1"
shift
flags="$*"

# Must be inside a git repo
repo_root=$(git rev-parse --show-toplevel 2>/dev/null) || {
  echo "Error: not inside a git repo"
  exit 1
}

worktree_dir="$repo_root/../website-$name"

# Create worktree if it doesn't exist
if [ ! -d "$worktree_dir" ]; then
  make -C "$repo_root" worktree branch="$name" folder="$name" flags="$flags"
else
  echo "Worktree already exists: $worktree_dir"
fi

# Resolve to absolute path
worktree_dir=$(cd "$worktree_dir" && pwd)

# Husky v9 needs .husky/_/ dir per worktree; copy-on-write skips `prepare` script
if [ -d "$worktree_dir/.husky" ] && [ ! -d "$worktree_dir/.husky/_" ]; then
  (cd "$worktree_dir" && npx husky 2>/dev/null) || true
fi

# If not inside tmux, start a new session
if [ -z "${TMUX:-}" ]; then
  tmux new-session -s "$name" -n "$name" -c "$worktree_dir" \; \
    select-pane -T "agent" \; \
    split-window -h -c "$worktree_dir" \; \
    select-pane -T "root" \; \
    select-pane -t 1 \; \
    split-window -v -f -c "$worktree_dir" -l 30% \; \
    select-pane -T "logs" \; \
    select-pane -t 1
  exit 0
fi

# Inside tmux — create a new window in the current session
tmux new-window -n "$name" -c "$worktree_dir"
tmux select-pane -T "agent"
tmux split-window -h -c "$worktree_dir"
tmux select-pane -T "root"
tmux select-pane -t 1
tmux split-window -v -f -c "$worktree_dir" -l 30%
tmux select-pane -T "logs"
tmux select-pane -t 1
