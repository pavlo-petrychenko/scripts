#!/usr/bin/env bash
# wtl - list all worktrees with branch, status, and resource info

set -euo pipefail

repo_root=$(git rev-parse --show-toplevel 2>/dev/null) || {
  echo "Error: not inside a git repo"
  exit 1
}

parent_dir=$(dirname "$repo_root")
main_repo="$parent_dir/website"

# Collect all dirs: main repo first, then worktrees
all_dirs="$main_repo"
worktree_dirs=$(ls -d "$parent_dir"/website-* 2>/dev/null || true)
if [ -n "$worktree_dirs" ]; then
  all_dirs="$all_dirs"$'\n'"$worktree_dirs"
fi

# Get tmux info
open_windows=""
current_window=""
if [ -n "${TMUX:-}" ]; then
  open_windows=$(tmux list-windows -F '#W' 2>/dev/null || true)
  current_window=$(tmux display-message -p '#W' 2>/dev/null || true)
fi

# Get VS Code open folders (one ps call for all)
vscode_windows=$(ps -eo args= | grep "[E]lectron.*/" || true)

# Header
printf "  %-18s %-11s %-6s %-6s %-7s %s\n" "NAME" "BRANCH" "TMUX" "CODE" "DIRTY" "LAST COMMIT"
printf "  %-18s %-11s %-6s %-6s %-7s %s\n" "----" "------" "----" "----" "-----" "-----------"

while IFS= read -r dir; do
  [ -z "$dir" ] && continue

  basename=$(basename "$dir")
  if [ "$basename" = "website" ]; then
    name="website"
  else
    name=$(echo "$basename" | sed 's/^website-//')
  fi

  # Active marker
  marker="  "
  if [ "$name" = "$current_window" ]; then
    marker="â–¸ "
  fi

  # Branch (cropped to 9 chars)
  branch=$(cd "$dir" && git branch --show-current 2>/dev/null || echo "???")
  branch="${branch:0:9}"

  # Tmux
  tmux_status="-"
  if echo "$open_windows" | grep -qx "$name"; then
    tmux_status="open"
  fi

  # Uncommitted changes
  change_count=$(cd "$dir" && git status --porcelain 2>/dev/null | wc -l | tr -d ' ')
  if [ "$change_count" = "0" ]; then
    dirty="clean"
  else
    dirty="${change_count}F"
  fi

  # Last commit age
  last_commit=$(cd "$dir" && git log -1 --format="%cr" 2>/dev/null || echo "???")

  # VS Code
  vscode="-"
  if echo "$vscode_windows" | grep -qF "$dir"; then
    vscode="open"
  fi

  printf "%s%-18s %-11s %-6s %-6s %-7s %s\n" "$marker" "$name" "$branch" "$tmux_status" "$vscode" "$dirty" "$last_commit"
done <<< "$all_dirs"
