#!/usr/bin/env bash
# wtl - list all worktrees with branch, status, and resource info

set -euo pipefail

repo_root=$(git rev-parse --show-toplevel 2>/dev/null) || {
  echo "Error: not inside a git repo"
  exit 1
}

parent_dir=$(dirname "$repo_root")
main_repo="$parent_dir/website"

# Collect all dirs: main repo first, then worktrees
all_dirs="$main_repo"
worktree_dirs=$(ls -d "$parent_dir"/website-* 2>/dev/null || true)
if [ -n "$worktree_dirs" ]; then
  all_dirs="$all_dirs"$'\n'"$worktree_dirs"
fi

# Get tmux info
open_windows=""
current_window=""
if [ -n "${TMUX:-}" ]; then
  open_windows=$(tmux list-windows -F '#W' 2>/dev/null || true)
  current_window=$(tmux display-message -p '#W' 2>/dev/null || true)
fi

# Header
printf "  %-18s %-11s %-6s %-7s %-16s %s\n" "NAME" "BRANCH" "TMUX" "DIRTY" "LAST COMMIT" "RAM"
printf "  %-18s %-11s %-6s %-7s %-16s %s\n" "----" "------" "----" "-----" "-----------" "---"

while IFS= read -r dir; do
  [ -z "$dir" ] && continue

  basename=$(basename "$dir")
  if [ "$basename" = "website" ]; then
    name="website"
  else
    name=$(echo "$basename" | sed 's/^website-//')
  fi

  # Active marker
  marker="  "
  if [ "$name" = "$current_window" ]; then
    marker="▸ "
  fi

  # Branch (cropped to 9 chars)
  branch=$(cd "$dir" && git branch --show-current 2>/dev/null || echo "???")
  branch="${branch:0:9}"

  # Tmux
  tmux_status="-"
  if echo "$open_windows" | grep -qx "$name"; then
    tmux_status="open"
  fi

  # Uncommitted changes
  change_count=$(cd "$dir" && git status --porcelain 2>/dev/null | wc -l | tr -d ' ')
  if [ "$change_count" = "0" ]; then
    dirty="clean"
  else
    dirty="${change_count}F"
  fi

  # Last commit age
  last_commit=$(cd "$dir" && git log -1 --format="%cr" 2>/dev/null || echo "???")

  # RAM usage — sum RSS of processes whose command line contains this directory
  pids=$(pgrep -f "$dir" 2>/dev/null || true)
  ram="-"
  if [ -n "$pids" ]; then
    ram_kb=$(echo "$pids" | xargs ps -o rss= -p 2>/dev/null | awk '{sum += $1} END {print sum+0}')
    if [ "$ram_kb" -gt 1048576 ]; then
      ram=$(awk "BEGIN {printf \"%.1fG\", $ram_kb/1048576}")
    elif [ "$ram_kb" -gt 0 ]; then
      ram=$(awk "BEGIN {printf \"%.0fM\", $ram_kb/1024}")
    fi
  fi

  printf "%s%-18s %-11s %-6s %-7s %-16s %s\n" "$marker" "$name" "$branch" "$tmux_status" "$dirty" "$last_commit" "$ram"
done <<< "$all_dirs"
